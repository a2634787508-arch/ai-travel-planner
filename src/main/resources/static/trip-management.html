<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>行程管理 - TravelEase</title>
    <!-- 引入Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- 引入Element Plus CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <!-- 引入Element Plus JS -->
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>

    <!-- 引入axios -->
    <script src="https://unpkg.com/axios@1.6.0/dist/axios.min.js"></script>
    <!-- 引入API模块 -->
    <script type="module" src="./js/api.js"></script>
    <link rel="stylesheet" href="./css/trip-management.css">

</head>

<body>
    <div id="app">
        <div class="container">
            <!-- 页面头部 -->
            <div class="header">
                <h1>行程管理</h1>
                <div class="header-actions">
                    <span class="user-info" id="user-name">欢迎，用户</span>
                    <el-button type="danger" size="small" id="logout-btn">退出登录</el-button>
                </div>
            </div>

            <!-- 主要内容区域 -->
            <div class="main-content">
                <!-- 工具栏 -->
                <div class="toolbar">
                    <div class="search-filters">
                        <el-input v-model="searchQuery" placeholder="搜索行程..." style="width: 200px" clearable />
                        <el-select v-model="selectedStatus" placeholder="状态筛选" style="width: 120px" clearable>
                            <el-option v-for="item in statusOptions" :key="item.value" :label="item.label"
                                :value="item.value" />
                        </el-select>
                        <el-button type="primary" @click="handleSearch">搜索</el-button>
                        <el-button @click="resetSearch">重置</el-button>
                    </div>
                    <div>
                        <el-button type="success" @click="showCreateDialog">
                            <el-icon>
                                <Plus />
                            </el-icon>
                            创建行程
                        </el-button>
                        <el-button @click="loadTrips">
                            <el-icon>
                                <Refresh />
                            </el-icon>
                            刷新
                        </el-button>
                    </div>
                </div>

                <!-- 行程列表 -->
                <div class="trip-table">
                    <!-- 页面初始加载状态 -->
                    <div v-if="loading && trips.length === 0" v-loading="loading" element-loading-text="正在加载行程数据..."
                        element-loading-background="rgba(255, 255, 255, 0.8)"
                        style="height: 300px; display: flex; align-items: center; justify-content: center;">
                    </div>

                    <div v-else-if="trips.length === 0" class="empty-state">
                        <h3>暂无行程</h3>
                        <p>点击"创建行程"按钮来规划您的第一次旅行</p>
                        <el-button type="primary" @click="showCreateDialog">创建行程</el-button>
                    </div>

                    <div v-else>
                        <!-- 数据刷新时的加载状态 -->
                        <div v-if="loading" v-loading="loading" element-loading-text="正在刷新数据..."
                            element-loading-background="rgba(255, 255, 255, 0.5)"
                            style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 1000; border-radius: 8px;">
                        </div>

                        <el-card v-for="trip in trips" :key="trip.id" class="trip-card">
                            <div class="trip-header">
                                <h3 class="trip-title">{{ trip.destination }}</h3>
                            </div>

                            <div class="trip-info">
                                <div class="info-item">
                                    <el-icon>
                                        <Calendar />
                                    </el-icon>
                                    {{ formatDate(trip.startDate) }} 至 {{ formatDate(trip.endDate) }}
                                </div>
                                <div class="info-item">
                                    <el-icon>
                                        <Money />
                                    </el-icon>
                                    预算: ¥{{ trip.totalBudget || '未设置' }}
                                </div>
                                <div class="info-item">
                                    <el-icon>
                                        <User />
                                    </el-icon>
                                    {{ trip.peopleCount || 1 }}人
                                </div>
                            </div>
                            <div class="trip-actions">
                                <el-button type="primary" size="small" @click="goToTripDetail(trip.id)">
                                    查看详情
                                </el-button>
                                <el-button type="warning" size="small" @click="editTrip(trip)">
                                    编辑
                                </el-button>
                                <el-button type="danger" size="small" @click="deleteTrip(trip.id)">
                                    删除
                                </el-button>
                            </div>
                        </el-card>
                    </div>
                </div>
            </div>
        </div>

        <!-- 创建/编辑行程对话框 -->
        <el-dialog v-model="dialogVisible" :title="dialogTitle" width="600px" @close="resetForm">
            <el-form ref="formRef" :model="formData" :rules="formRules" label-width="100px">
                <!-- AI智能生成区域 -->
                <div class="ai-generate-section">
                    <h4 style="margin-bottom: 15px; color: #409eff;">
                        <el-icon>
                            <MagicStick />
                        </el-icon>
                        AI智能生成行程
                    </h4>
                    <el-input v-model="naturalLanguageInput" type="textarea"
                        placeholder="例如：我想在春节假期去三亚旅游7天，预算5000元，喜欢海滩和美食" class="ai-input" />
                    <el-button type="success" @click="generateTripByAI" style="width: 100%;">
                        <el-icon>
                            <MagicStick />
                        </el-icon>
                        AI生成行程
                    </el-button>
                </div>

                <el-divider content-position="center">或手动填写</el-divider>

                <el-form-item label="目的地" prop="destination">
                    <el-input v-model="formData.destination" placeholder="请输入目的地" />
                </el-form-item>

                <el-form-item label="开始日期" prop="startDate">
                    <el-date-picker v-model="formData.startDate" type="date" placeholder="选择开始日期" style="width: 100%" />
                </el-form-item>

                <el-form-item label="结束日期" prop="endDate">
                    <el-date-picker v-model="formData.endDate" type="date" placeholder="选择结束日期" style="width: 100%" />
                </el-form-item>

                <el-form-item label="预算" prop="budget">
                    <el-input-number v-model="formData.totalBudget" :min="0" placeholder="请输入预算" style="width: 100%" />
                </el-form-item>

                <el-form-item label="人数" prop="peopleCount">
                    <el-input-number v-model="formData.peopleCount" :min="1" placeholder="请输入人数" style="width: 100%" />
                </el-form-item>

                <el-form-item label="偏好" prop="preferences">
                    <el-input v-model="formData.preferences" type="textarea" placeholder="请输入特殊需求（可选）" />
                </el-form-item>
            </el-form>

            <template #footer>
                <div class="dialog-footer">
                    <el-button @click="dialogVisible = false">取消</el-button>
                    <el-button type="primary" @click="submitForm">确定</el-button>
                </div>
            </template>
        </el-dialog>
    </div>



    <script type="module">
        import { travelPlanApi, checkLogin, getCurrentUser, redirectWithToken } from './js/api.js';

        const { createApp, ref, reactive, computed, onMounted } = Vue;

        const { ElMessage, ElLoading } = ElementPlus;

        // 创建Vue应用
        const app = createApp({
            setup() {
                // 响应式数据
                const dialogVisible = ref(false);
                const dialogTitle = ref('创建行程');
                const editingId = ref(null);
                const trips = ref([]);
                const loading = ref(false);
                const searchQuery = ref('');
                const selectedStatus = ref('');
                const currentPage = ref(1);
                const pageSize = ref(10);
                const formData = reactive({
                    destination: '',
                    startDate: '',
                    endDate: '',
                    totalBudget: null,
                    peopleCount: 1,
                    preferences: ''
                });
                const naturalLanguageInput = ref('');
                const formRules = reactive({});
                const statusOptions = reactive([
                    { label: '即将开始', value: 'upcoming' },
                    { label: '进行中', value: 'on-going' },
                    { label: '已完成', value: 'completed' },
                    { label: '已取消', value: 'cancelled' }
                ]);

                // 生命周期钩子
                onMounted(async () => {
                    await initPage();
                });

                // 初始化页面
                const initPage = async () => {
                    // 检查登录状态
                    if (!checkLogin()) {
                        window.location.href = 'login.html';
                        return;
                    }
                    // 显示用户信息
                    const currentUser = getCurrentUser();
                    if (currentUser) {
                        const userNameElement = document.getElementById('user-name');
                        if (userNameElement) {
                            userNameElement.textContent = `欢迎，${currentUser.username || currentUser.email || '用户'}`;
                        }
                    }
                    // 加载行程数据
                    await loadTrips();
                };
                // 加载行程数据
                const loadTrips = () => {
                    loading.value = true;
                    travelPlanApi.getUserTravelPlans()
                        .then(travelPlanList => trips.value = travelPlanList || [])
                        .catch(error => {
                            console.error('加载行程数据失败:', error);
                            ElMessage.error('加载行程数据失败');
                        })
                        .finally(() => loading.value = false);
                };
                // 编辑行程
                const editTrip = (trip) => {
                    editingId.value = trip.id;
                    dialogTitle.value = '编辑行程';
                    Object.assign(formData, JSON.parse(JSON.stringify(trip)));
                    dialogVisible.value = true;
                };

                // 删除行程
                const deleteTrip = async (id) => {
                    if (confirm('确定要删除这个行程吗？此操作不可撤销。')) {
                        try {
                            await travelPlanApi.deleteTravelPlan(id);
                            ElementPlus.ElMessage.success('删除成功');
                            await loadTrips();
                        } catch (error) {
                            console.error('删除行程失败:', error);
                            ElementPlus.ElMessage.error('删除行程失败');
                        }
                    }
                };

                // 显示创建对话框
                const showCreateDialog = () => {
                    dialogTitle.value = '创建行程';
                    editingId.value = null;
                    resetForm();
                    dialogVisible.value = true;
                };

                // 重置表单
                const resetForm = () => {
                    Object.assign(formData, {
                        destination: '',
                        startDate: '',
                        endDate: '',
                        totalBudget: null,
                        peopleCount: 1,
                        preferences: ''
                    });
                    naturalLanguageInput.value = '';
                };

                const goToTripDetail = (tripId) => {
                    redirectWithToken(`trip-detail.html?id=${tripId}`)
                };

                // 提交表单
                const submitForm = async () => {
                    const loadingInstance = ElLoading.service({
                        lock: true,
                        text: 'Ai正在生成规划，请稍等...',
                        background: 'rgba(0, 0, 0, 0.7)'
                    });
                    try {
                        let newTripId = null;
                        if (editingId.value) {
                            // 编辑行程
                            newTripId = await travelPlanApi.updateTravelPlan(editingId.value, formData);
                            ElMessage.success('更新成功');
                        } else {
                            // 创建行程
                            newTripId = await travelPlanApi.createTravelPlan(formData);
                            ElMessage.success('创建成功');
                        }
                        await loadTrips();
                        goToTripDetail(newTripId);
                    } catch (error) {
                        console.error('保存行程失败:', error);
                        ElMessage.error('保存行程失败');
                    } finally {
                        loadingInstance.close();
                        dialogVisible.value = false;
                    }
                };

                // 状态文本映射
                const getStatusText = (status) => {
                    const statusMap = {
                        'upcoming': '即将开始',
                        'on-going': '进行中',
                        'completed': '已完成',
                        'cancelled': '已取消'
                    };
                    return statusMap[status] || status;
                };

                // 日期格式化函数
                const formatDate = (dateString) => {
                    if (!dateString) return '';
                    try {
                        const date = new Date(dateString);
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    } catch (error) {
                        console.error('日期格式化错误:', error);
                        return dateString;
                    }
                };

                // 搜索功能
                const handleSearch = () => {
                    // TODO 实现搜索逻辑
                    console.log('搜索功能待实现');
                };

                // 重置搜索
                const resetSearch = () => {
                    searchQuery.value = '';
                    selectedStatus.value = '';
                    loadTrips();
                };

                // 分页功能
                const handleSizeChange = (size) => {
                    pageSize.value = size;
                    loadTrips();
                };

                const handleCurrentChange = (page) => {
                    currentPage.value = page;
                    loadTrips();
                };

                // 返回所有需要在模板中使用的数据和方法
                return {
                    // 响应式数据
                    trips,
                    loading,
                    searchQuery,
                    selectedStatus,
                    currentPage,
                    pageSize,
                    dialogVisible,
                    dialogTitle,
                    editingId,
                    formData,
                    naturalLanguageInput,
                    formRules,
                    statusOptions,

                    // 方法
                    loadTrips,
                    handleSearch,
                    goToTripDetail,
                    resetSearch,
                    handleSizeChange,
                    handleCurrentChange,
                    showCreateDialog,
                    editTrip,
                    deleteTrip,
                    submitForm,
                    resetForm,
                    getStatusText,
                    formatDate,
                    initPage
                };
            }
        });

        // 使用Element Plus
        app.use(ElementPlus);

        // 挂载应用
        app.mount('#app');

        // 退出登录功能
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        });
    </script>
</body>

</html>