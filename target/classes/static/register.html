<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注册 - 智能旅行规划系统</title>
    <!-- 引入Element Plus CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-plus/dist/index.css">
    <!-- 引入全局CSS -->
    <link rel="stylesheet" href="css/global.css">

    <!-- 引入Vue 3 -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3"></script>
    <!-- 引入Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- 引入Element Plus JS -->
    <script src="https://cdn.jsdelivr.net/npm/element-plus/dist/index.full.js"></script>
</head>

<body>
    <div class="auth-container" id="app">
        <h1 class="auth-title">创建新账号</h1>
        <form @submit.prevent="handleRegister">
            <div class="form-group">
                <label for="username">用户名</label>
                <input type="text" id="username" v-model="form.username" placeholder="请输入用户名" required>
                <div class="error-message" v-if="errors.username">{{ errors.username }}</div>
            </div>
            <div class="form-group">
                <label for="password">密码</label>
                <input type="password" id="password" v-model="form.password" placeholder="请输入密码（至少6位）" required>
                <div class="error-message" v-if="errors.password">{{ errors.password }}</div>
            </div>
            <div class="form-group">
                <label for="email">邮箱（可选）</label>
                <input type="email" id="email" v-model="form.email" placeholder="请输入邮箱地址">
                <div class="error-message" v-if="errors.email">{{ errors.email }}</div>
            </div>
            <button type="submit" class="btn" :disabled="loading">{{ loading ? '注册中...' : '注册' }}</button>
            <div class="link-text">
                已有账号？<a href="login.html">立即登录</a>
            </div>
        </form>
    </div>


    <!-- 引入API配置 -->
    <script src="js/api.js" type="module"></script>
    <script type="module">

        // 导入API模块
        const { authApi } = await import('./js/api.js');
        const { createApp } = Vue;
        const { ElMessage } = ElementPlus;

        // 创建Vue应用
        const app = createApp({
            setup() {
                const { ref, onMounted } = Vue;
                
                // 响应式数据
                const form = ref({
                    username: '',
                    password: '',
                    email: ''
                });
                const errors = ref({});
                const loading = ref(false);

                // 组件挂载时检查登录状态
                onMounted(() => {
                    // 检查是否已经登录，如果已登录则跳转到首页
                    const token = localStorage.getItem('token');
                    if (token) {
                        window.location.href = 'index.html';
                    }
                });

                // 表单验证方法
                const validateForm = () => {
                    errors.value = {};
                    let isValid = true;

                    // 验证用户名
                    if (!form.value.username.trim()) {
                        errors.value.username = '用户名不能为空';
                        isValid = false;
                    } else if (form.value.username.length < 3) {
                        errors.value.username = '用户名至少需要3个字符';
                        isValid = false;
                    }

                    // 验证密码
                    if (!form.value.password.trim()) {
                        errors.value.password = '密码不能为空';
                        isValid = false;
                    } else if (form.value.password.length < 6) {
                        errors.value.password = '密码至少需要6个字符';
                        isValid = false;
                    }

                    // 验证邮箱（如果填写了）
                    if (form.value.email && !validateEmail(form.value.email)) {
                        errors.value.email = '请输入有效的邮箱地址';
                        isValid = false;
                    }

                    return isValid;
                };

                // 邮箱验证方法
                const validateEmail = (email) => {
                    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    return re.test(email);
                };

                // 注册处理方法
                const handleRegister = async () => {
                    if (!validateForm()) {
                        return;
                    }

                    loading.value = true;
                    try {
                        const response = await authApi.register(form.value);

                        // 显示成功消息
                        ElMessage.success('注册成功');

                        // 跳转到登录页面
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 1500);
                    } catch (error) {
                        // 错误已经在API拦截器中处理
                        console.error('注册失败:', error);
                    } finally {
                        loading.value = false;
                    }
                };

                // 返回需要在模板中使用的数据和方法
                return {
                    form,
                    errors,
                    loading,
                    validateForm,
                    validateEmail,
                    handleRegister
                };
            }
        });

        // 使用Element Plus
        app.use(ElementPlus);
        app.mount('#app');

    </script>
</body>

</html>